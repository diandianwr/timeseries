---
title: "Thesis Progress Update"
author: "Weiran Zhao"
date: "Feb 23, 2016"
output: pdf_document
---

In the following, updates will be reported with regard to:

1. Prepared regressors and convert datasets to timeseries formate
2. fit arima model
3. comparing result



##  dataset summary
```{r ktable,message=FALSE,message=FALSE}
library(dplyr)
library(tscount)
library(zoo)
library(forecast)
library(knitr)
library(texreg)
library(ggplot2)
library(stargazer)

# setwd("/Users/weiran/Google Drive/WeiweiThesis/BicycleCount/bikecounts")
setwd("~/Google Drive/WeiweiThesis/BicycleCount/bikecounts")


bcraw.df <- read.csv("Data/weatherbike2yr.csv",stringsAsFactors=F)

bcraw.df <- bcraw.df[,c(5,4,12,13,15:17,19,25:36)]
kable(head(bcraw.df[,c(1:7)], 2),caption ="First 7 rows of dataset ")
kable(head(bcraw.df[,c(7:14)], 2))
kable(head(bcraw.df[,c(15:20)], 2))

```


#fiting time series model
##Model specification
```{r,echo=FALSE}
bc.df <- bcraw.df %>%
  select(Date,count,precipIntensityMax,temperatureMax,dow,holiday,uw) %>%
  mutate(dow=as.numeric(as.factor(dow)))

```

Regressors  | Description
------------- | -------------
Date| Date of observation
count | count of bike per day
precipIntensityMax | Daily maximum inches of precipitation in any hour
temperatureMax| Maximum temperature for the day
Holiday | Day of the week dummy variable (relative to Sunday)
dow  | Day of the week dummy variable (relative to Sunday)
uw | whether UW is in session

## models
model type | model | Description
------------- | -------------
ARIMA | model1 | using arima model without day of week(dow)
ARIMA | model2 | using arima model with all 5 regressors above
GLM | mod_nb | using Negtive Binominal model
GLM with auto regressive |using Negtive Binominal model with time series auto regressive
 

## ARIMA model

```{r echo=FALSE}
#change to Data type
bc.df$Date <- as.Date(bc.df$Date,"%Y-%m-%d") 
bc.zoo <- zoo(bc.df[,-1],bc.df[,1])
bc.ts <- as.ts(bc.zoo)

#----------------------model fitting
#arima pretest
count.ts <- bc.ts[,1]
auto.arima(count.ts)  

# Model1: without day of week
model1_reg <- as.matrix(bc.df[,3:5])  # select regressor and convert to matrix
rownames(model1_reg) <- seq(1,nrow(model1_reg))

model1 <- Arima(count.ts,order=c(3,1,3),xreg=model1_reg)   

# Model 2: add day of week as regressor
dow<-model.matrix(~as.factor(bc.df$dow))[,2:7]  # prepare model 2 regressors
colnames(dow) <- c('Mon','Sat','Sun','Thurs','Tues','Wed')
dow <- dow[,c(2,3,1,5,6,4)]
model2_reg <- cbind(model1_reg,dow)

model2 <- Arima(count.ts,order=c(3,1,3),xreg=model2_reg)
```

###two arima models commparison

```{r,results='asis'}
stargazer(model2, title="Regression Results",single.row=TRUE)
```

```{r fig.width = 7, fig.height = 7}
tsdiag(model1)
```

```{r fig.width = 7, fig.height = 7}
tsdiag(model2)
```

```{r fig.width = 4, fig.height = 4}
ggplot(data.frame(actual=bc.df$count, predicted=fitted.values(model1)),
       aes(x=actual, y=predicted)) +
  geom_abline(intercept=0, slope=1, color="red") +
  geom_point() + theme_bw()
```

```{r fig.width = 4, fig.height = 4}

ggplot(data.frame(actual=bc.df$count, predicted=fitted.values(model2)),
       aes(x=actual, y=predicted)) +
  geom_abline(intercept=0, slope=1, color="red") +
  geom_point() + theme_bw()
```


```{r setup, fig.width = 7, fig.height = 3}
plot(count)
lines(fitted(model2),col=2)

```



